<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Manual | YEPRI-INN METAX</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --accent: #3b82f6;
            --glass: rgba(255, 255, 255, 0.08);
            --border: rgba(255, 255, 255, 0.15);
            --bg: #020617;
        }

        body {
            margin: 0; font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top right, #1e3a8a 0%, #020617 100%);
            color: white; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px;
        }

        /* Spinner de Carga Inicial */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }
        .spinner { width: 50px; height: 50px; border: 5px solid var(--glass); border-top: 5px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Contenedor Principal */
        .container { width: 100%; max-width: 950px; backdrop-filter: blur(12px); }
        .form-card {
            background: var(--glass); padding: 40px; border-radius: 30px; border: 1px solid var(--border);
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }

        h2 { grid-column: span 2; font-weight: 300; margin: 0 0 10px 0; border-bottom: 1px solid var(--border); padding-bottom: 15px; }

        .input-box { display: flex; flex-direction: column; gap: 8px; }
        .full-width { grid-column: span 2; }

        label { font-size: 0.7rem; text-transform: uppercase; opacity: 0.6; letter-spacing: 1.5px; font-weight: 600; }

        input, select, textarea {
            background: rgba(0, 0, 0, 0.4); border: 1px solid var(--border);
            padding: 14px; border-radius: 12px; color: white; font-family: inherit; transition: 0.3s;
        }
        
        input:focus, select:focus { border-color: var(--accent); outline: none; background: rgba(0,0,0,0.6); }
        input[readonly] { background: rgba(255, 255, 255, 0.03); color: #60a5fa; border-style: dashed; cursor: not-allowed; }

        /* Buscador de Siglas */
        #siglasEmisor { height: 120px; font-size: 0.9rem; }

        /* √Årea de Salidas e Interruptor */
        .switch-area {
            grid-column: span 2; background: rgba(59, 130, 246, 0.1);
            padding: 20px; border-radius: 15px; border: 1px solid rgba(59, 130, 246, 0.2);
            display: flex; align-items: center; justify-content: space-between;
        }

        .btn-registrar {
            grid-column: span 2; background: var(--accent); color: white; border: none;
            padding: 18px; border-radius: 14px; font-weight: 600; cursor: pointer;
            transition: 0.3s; font-size: 1.1rem; margin-top: 10px;
        }
        .btn-registrar:hover { background: #2563eb; transform: translateY(-3px); box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3); }

        /* Modal Resumen */
        #modalResumen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(2, 6, 23, 0.98); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(20px);
        }
        .modal-content {
            background: #0f172a; padding: 40px; border-radius: 28px; border: 1px solid var(--accent);
            max-width: 450px; width: 90%; text-align: center;
        }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <p style="margin-top: 20px; letter-spacing: 2px; font-size: 0.8rem;">SINCRONIZANDO YEPRI-INN...</p>
</div>

<div class="container">
    <div class="form-card">
        <h2>Registro de Correspondencia <span style="color:var(--accent)">Manual</span></h2>
        
        <div class="input-box full-width">
            <label>üîç Buscar Siglas Emisor (Sujeto)</label>
            <input type="text" id="busquedaSiglas" placeholder="Escriba para filtrar (ej: METAX)..." oninput="filtrarSiglas(this.value)">
            <select id="siglasEmisor" size="5" onchange="autoLlenarCampos(this.value)">
                </select>
        </div>

        <div class="input-box">
            <label>üè¢ Dependencia / Ente</label>
            <input type="text" id="dependencia" readonly placeholder="Auto-completado">
        </div>
        <div class="input-box">
            <label>üë§ Firmante (Enlace)</label>
            <input type="text" id="firmante" readonly placeholder="Auto-completado">
        </div>
        <div class="input-box full-width">
            <label>üíº Cargo / Puesto</label>
            <input type="text" id="puesto" readonly placeholder="Auto-completado">
        </div>

        <div class="input-box">
            <label>‚öñÔ∏è Tipo de Gesti√≥n</label>
            <select id="tipoGestion">
                <option value="Administrativo">üìÇ Administrativo</option>
                <option value="T√©cnico">üõ†Ô∏è T√©cnico / Operativo</option>
                <option value="Legal">‚öñÔ∏è Legal / Jur√≠dico</option>
                <option value="Urgente">üö® Asunto Urgente</option>
            </select>
        </div>

        <div class="input-box">
            <label>üíæ Dispositivo / Medio</label>
            <select id="tipoDispositivo" onchange="verificarOtro(this.value)">
                <option value="N/A">üö´ Ninguno</option>
                <option value="CD 700 MB">üíø CD - 700 MB</option>
                <option value="DVD 4.5 GB">üìÄ DVD - 4.5 GB</option>
                <option value="USB 16 GB">‚ö° USB - 16 GB</option>
                <option value="USB 32 GB">‚ö° USB - 32 GB</option>
                <option value="Otro">üì§ Otro (Especificar)</option>
            </select>
        </div>

        <div class="input-box full-width" id="especificarOtroBox" style="display:none">
            <label>üîç Especificar Dispositivo</label>
            <input type="text" id="otroDetalle" placeholder="Ej: Disco Duro Externo...">
        </div>

        <div class="input-box full-width">
            <label>üìù Asunto / Referencia</label>
            <textarea id="asunto" rows="3" placeholder="Descripci√≥n del documento..."></textarea>
        </div>

        <div class="switch-area">
            <div>
                <strong>¬øGenerar Folios de Salida (S-OFA)?</strong>
                <small style="display:block; opacity:0.5">Mismo consecutivo, formato serie.</small>
            </div>
            <div style="display:flex; gap:10px">
                <input type="checkbox" id="checkSalida" style="width:20px; height:20px">
                <input type="number" id="cantSalidas" value="1" min="1" max="50" style="width:60px; text-align:center">
            </div>
        </div>

        <button class="btn-registrar" id="btnMain" onclick="ejecutarRegistroGlobal()">Finalizar Registro</button>
    </div>
</div>

<div id="modalResumen">
    <div class="modal-content">
        <div style="color:#4ade80; font-size:3rem">‚úì</div>
        <h3>Registro Completado</h3>
        <div id="listaFolios" style="background:rgba(0,0,0,0.3); padding:20px; border-radius:15px; text-align:left; margin:20px 0; font-family:monospace; color:var(--accent);"></div>
        <div style="display:flex; gap:10px">
            <button onclick="copiarFoliosAlPortapapeles()" style="flex:1; padding:12px; border-radius:10px; cursor:pointer; background:rgba(255,255,255,0.05); color:white; border:1px solid var(--border);">üìã Copiar</button>
            <button onclick="location.reload()" style="flex:1; padding:12px; border-radius:10px; cursor:pointer; background:var(--accent); color:white; border:none;">Finalizar</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const _supabase = supabase.createClient('https://zfztocmwphjfrabvbzlb.supabase.co', 'sb_publishable_cbOD6KTnjsGacu_GnAQm8g_nMuIoOIg');
    let todasLasSiglas = [];
    let textoCopia = "";

    // 1. Carga inicial
    window.onload = async () => {
        const { data } = await _supabase.from('enlacesdirec').select('*').order('sujeto');
        if (data) {
            todasLasSiglas = data;
            renderizarOpciones(data);
        }
        document.getElementById('loader').style.opacity = '0';
        setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
    };

    function renderizarOpciones(lista) {
        const select = document.getElementById('siglasEmisor');
        select.innerHTML = lista.map(item => `<option value="${item.sujeto}">üè¢ ${item.sujeto}</option>`).join('');
    }

    function filtrarSiglas(t) {
        renderizarOpciones(todasLasSiglas.filter(i => i.sujeto.toLowerCase().includes(t.toLowerCase())));
    }

    function autoLlenarCampos(s) {
        const reg = todasLasSiglas.find(i => i.sujeto === s);
        if (reg) {
            document.getElementById('dependencia').value = reg.entidad;
            document.getElementById('firmante').value = reg.enlace;
            document.getElementById('puesto').value = reg.puesto;
        }
    }

    function verificarOtro(v) {
        document.getElementById('especificarOtroBox').style.display = (v === 'Otro') ? 'flex' : 'none';
    }

    async function ejecutarRegistroGlobal() {
        const sigla = document.getElementById('siglasEmisor').value;
        const asunto = document.getElementById('asunto').value;
        if (!sigla || !asunto) return alert("Faltan datos.");

        document.getElementById('btnMain').disabled = true;
        
        let disp = document.getElementById('tipoDispositivo').value;
        if(disp === 'Otro') disp = "OTRO: " + document.getElementById('otroDetalle').value;

        try {
            const { data: info } = await _supabase.rpc('generar_folios_duo_seguro');
            const { consecutivo_num, folio_e } = info[0];

            // Inserciones masivas
            await _supabase.from('correspondencias').insert([{
                consecutivo: consecutivo_num,
                siglas_emisor: sigla,
                asunto: asunto,
                folio_entrada: folio_e,
                tipo_dispositivo: disp
            }]);

            await _supabase.from('folios_entrada').insert([{
                consecutivo: consecutivo_num,
                ofa_e_folio: folio_e,
                origen: sigla
            }]);

            let resHtml = `Entrada: <strong>${folio_e}</strong><br>`;
            textoCopia = `FOLIO ENTRADA: ${folio_e}\n`;

            if (document.getElementById('checkSalida').checked) {
                const n = parseInt(document.getElementById('cantSalidas').value);
                const salidas = [];
                for (let i = 1; i <= n; i++) {
                    const f = `S-OFA-` + i.toString().padStart(5, '0');
                    salidas.push({ consecutivo_madre: consecutivo_num, ofa_s_folio: f });
                    resHtml += `‚Ä¢ ${f}<br>`;
                    textoCopia += `SALIDA: ${f}\n`;
                }
                await _supabase.from('folios_salida').insert(salidas);
            }

            document.getElementById('listaFolios').innerHTML = resHtml;
            document.getElementById('modalResumen').style.display = 'flex';
        } catch (e) { alert(e.message); document.getElementById('btnMain').disabled = false; }
    }

    function copiarFoliosAlPortapapeles() {
        navigator.clipboard.writeText(textoCopia);
        alert("Copiado al portapapeles");
    }
</script>
</body>
</html>
