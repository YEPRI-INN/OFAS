<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registro de Correspondencia | YEPRI-INN</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #f1f5f9; --border: #cbd5e1; --text-main: #334155; --accent: #3b82f6; --danger: #ef4444;
        }
        body { margin: 0; font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); padding: 30px; }
        
        /* Dashboard */
        .dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
        .card { background: white; padding: 15px 20px; border-radius: 10px; border-left: 4px solid var(--accent); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .card.red { border-left-color: var(--danger); }
        .card-label { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; color: #64748b; margin-bottom: 5px; }
        .card-value { font-size: 1.6rem; font-weight: 600; color: #1e293b; }

        /* Estructura Secciones */
        .section { background: white; border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 20px; position: relative; }
        .section-title { position: absolute; top: -10px; left: 15px; background: white; padding: 0 8px; font-size: 0.7rem; font-weight: 900; color: #1e293b; text-transform: uppercase; }

        .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; margin-bottom: 12px; }
        .col-1 { grid-column: span 1; } .col-2 { grid-column: span 2; } .col-3 { grid-column: span 3; } .col-4 { grid-column: span 4; } .col-12 { grid-column: span 12; }

        .group { display: flex; flex-direction: column; gap: 4px; }
        label { font-size: 0.65rem; font-weight: 800; color: #1e293b; text-transform: uppercase; }
        
        input, select, textarea { border: 1px solid var(--border); padding: 8px 10px; border-radius: 5px; font-size: 0.85rem; color: #334155; outline: none; }
        input[readonly] { background: #f8fafc; color: #64748b; cursor: not-allowed; }
        .input-solicitud { border: 1.5px solid var(--danger); color: var(--danger); font-weight: 600; }

        .btn-save { float: right; background: #1e293b; color: white; border: none; padding: 12px 30px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-save:hover { background: #334155; transform: translateY(-1px); }
        .btn-save:disabled { opacity: 0.5; cursor: not-allowed; }

        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:1000; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    </style>
</head>
<body>

<div id="loader">
    <div style="width:35px; height:35px; border:4px solid #f3f3f3; border-top:4px solid #3b82f6; border-radius:50%; animation:spin 1s linear infinite;"></div>
    <p style="margin-top:15px; font-size:0.75rem; font-weight:700; letter-spacing:1px">SINCRONIZANDO...</p>
</div>

<div class="dashboard">
    <div class="card"><div class="card-label">Registros Hoy</div><div class="card-value" id="stats-hoy">0</div></div>
    <div class="card red"><div class="card-label">üö® Vencen Hoy</div><div class="card-value" style="color:var(--danger)">1</div></div>
    <div class="card"><div class="card-label">En Proceso</div><div class="card-value">11</div></div>
    <div class="card"><div class="card-label">Atendidos</div><div class="card-value">2</div></div>
</div>

<div class="section">
    <span class="section-title">Identificadores del Registro</span>
    <div class="row">
        <div class="group col-3"><label>Consecutivo</label><input type="text" id="consecutivo" readonly></div>
        <div class="group col-3"><label>Folio Entrada (OFA-A)</label><input type="text" id="folio_e" readonly></div>
        <div class="group col-3"><label>Folio Interno CSF</label><input type="text" id="folio_interno"></div>
        <div class="group col-3"><label style="color:var(--danger)">Oficio de Solicitud</label><input type="text" id="oficio_solicitud" class="input-solicitud" placeholder="Ingresar folio..."></div>
    </div>
</div>

<div class="section">
    <span class="section-title">Informaci√≥n T√©cnica del Oficio</span>
    <div class="row">
        <div class="group col-2"><label>No. Oficio Emisor</label><input type="text" id="num_oficio_emisor"></div>
        <div class="group col-2"><label>Fecha Recepci√≥n</label><input type="date" id="fecha_recepcion" value="2026-02-24"></div>
        <div class="group col-2">
            <label>Medio</label>
            <select id="medio"><option>Impreso (F√≠sico)</option><option>Digital (Correo)</option></select>
        </div>
        <div class="group col-2">
            <label>Tipo Dispositivo</label>
            <select id="tipo_dispositivo">
                <option>Ninguno</option><option>CD</option><option>DVD</option><option>USB 8GB</option><option>USB 16GB</option>
            </select>
        </div>
        <div class="group col-2"><label>Cap. Info</label><input type="number" id="cap_info" value="0"></div>
        <div class="group col-2">
            <label>Unidad Medida</label>
            <select id="unidad_medida"><option>N/A</option><option>MB</option><option>GB</option></select>
        </div>
    </div>
</div>

<div class="section">
    <span class="section-title">Emisor y Seguimiento</span>
    <div class="row">
        <div class="group col-3">
            <label>Siglas Emisor</label>
            <input type="text" id="search" placeholder="Busque sigla..." oninput="filtrar(this.value)" style="margin-bottom:5px">
            <select id="siglas" onchange="llenar(this.value)"></select>
        </div>
        <div class="group col-3"><label>Dependencia / Ente</label><input type="text" id="dep" readonly></div>
        <div class="group col-2"><label>Firmante</label><input type="text" id="fir" readonly></div>
        <div class="group col-2"><label>Cargo</label><input type="text" id="car" readonly></div>
        <div class="group col-1"><label>Oficio atiende</label><input type="text" id="oficio_atiende"></div>
        <div class="group col-1"><label>Vencimiento</label><input type="date" id="fecha_vencimiento" value="2026-03-02"></div>
    </div>
</div>

<div class="section">
    <span class="section-title">Acciones y Asunto</span>
    <div class="row">
        <div class="group col-4">
            <label>Acci√≥n</label>
            <select id="accion"><option>Para respuesta</option><option>Para conocimiento</option></select>
        </div>
        <div class="group col-4"><label>Salidas (S-OFA)</label><input type="number" id="cant_salidas" value="0"></div>
        <div class="group col-4">
            <label>Estatus</label>
            <select id="estatus"><option>Recibido</option><option>En Proceso</option></select>
        </div>
        <div class="group col-12"><label>Asunto</label><textarea id="asunto" rows="3"></textarea></div>
    </div>
</div>

<button class="btn-save" id="btnGuardar" onclick="guardarRegistro()">Guardar Registro Manual</button>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const _supabase = supabase.createClient('https://zfztocmwphjfrabvbzlb.supabase.co', 'sb_publishable_cbOD6KTnjsGacu_GnAQm8g_nMuIoOIg');
    let dataCache = [];

    window.onload = async () => {
        try {
            const { data: enlaces } = await _supabase.from('enlacesdirec').select('*').order('sujeto');
            dataCache = enlaces;
            updateCombo(enlaces);

            const { data: folios } = await _supabase.rpc('generar_folios_duo_seguro');
            if(folios){
                document.getElementById('consecutivo').value = folios[0].consecutivo_num;
                document.getElementById('folio_e').value = folios[0].folio_e;
            }
            document.getElementById('loader').style.display = 'none';
        } catch(e) { console.error(e); }
    };

    function updateCombo(lista) {
        const sel = document.getElementById('siglas');
        sel.innerHTML = '<option value="">-- Seleccionar --</option>' + 
            lista.map(i => `<option value="${i.sujeto}">${i.sujeto} | ${i.entidad}</option>`).join('');
    }

    function filtrar(t) {
        updateCombo(dataCache.filter(i => i.sujeto.toLowerCase().includes(t.toLowerCase())));
    }

    function llenar(s) {
        const item = dataCache.find(i => i.sujeto === s);
        if(item) {
            document.getElementById('dep').value = item.entidad;
            document.getElementById('fir').value = item.enlace;
            document.getElementById('car').value = item.puesto;
        }
    }

    async function guardarRegistro() {
        const btn = document.getElementById('btnGuardar');
        const sigla = document.getElementById('siglas').value;
        if(!sigla || !document.getElementById('asunto').value) return alert("Complete los campos obligatorios.");

        btn.disabled = true;
        btn.innerText = "Guardando...";

        try {
            const cons = document.getElementById('consecutivo').value;
            const fe = document.getElementById('folio_e').value;

            // 1. Insertar Correspondencia (Todos los campos de la imagen)
            const { error: err1 } = await _supabase.from('correspondencias').insert([{
                consecutivo: cons,
                folio_entrada: fe,
                folio_interno_csf: document.getElementById('folio_interno').value,
                oficio_solicitud: document.getElementById('oficio_solicitud').value,
                num_oficio_remitente: document.getElementById('num_oficio_emisor').value,
                fecha_recepcion: document.getElementById('fecha_recepcion').value,
                medio_recepcion: document.getElementById('medio').value,
                tipo_dispositivo: document.getElementById('tipo_dispositivo').value,
                capacidad_info: document.getElementById('cap_info').value,
                unidad_medida: document.getElementById('unidad_medida').value,
                siglas_emisor: sigla,
                dependencia: document.getElementById('dep').value,
                firmante: document.getElementById('fir').value,
                cargo: document.getElementById('car').value,
                oficio_que_atiende: document.getElementById('oficio_atiende').value,
                fecha_vencimiento: document.getElementById('fecha_vencimiento').value,
                accion: document.getElementById('accion').value,
                estatus: document.getElementById('estatus').value,
                asunto: document.getElementById('asunto').value
            }]);

            if(err1) throw err1;

            // 2. Insertar Folio de Entrada
            await _supabase.from('folios_entrada').insert([{ consecutivo: cons, ofa_e_folio: fe, origen: sigla }]);

            // 3. Generar Salidas si se especificaron
            const numSalidas = parseInt(document.getElementById('cant_salidas').value);
            if(numSalidas > 0) {
                const registrosSalida = [];
                for(let i=1; i<=numSalidas; i++) {
                    registrosSalida.push({
                        consecutivo_madre: cons,
                        ofa_s_folio: `S-OFA-` + i.toString().padStart(4, '0') // Formato S-OFA-0000
                    });
                }
                await _supabase.from('folios_salida').insert(registrosSalida);
            }

            alert("Registro Guardado Exitosamente.");
            location.reload();
        } catch(e) {
            alert("Error: " + e.message);
            btn.disabled = false;
        }
    }
</script>
<style> @keyframes spin { 100% { transform: rotate(360deg); } } </style>
</body>
</html>
