<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registro Maestro Pro | YEPRI-INN</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #3b82f6;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.12);
            --bg: #020617;
            --success: #4ade80;
            --danger: #ef4444;
        }

        body {
            margin: 0; font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top right, #111827, #020617);
            color: white; min-height: 100vh; padding: 20px;
        }

        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--glass); border-top: 3px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .container { max-width: 1200px; margin: 0 auto; }
        
        /* Dashboard Stats */
        .dashboard-mini {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;
        }
        .stat-card {
            background: var(--glass); padding: 15px; border-radius: 12px; border: 1px solid var(--border);
            border-left: 4px solid var(--accent);
        }
        .stat-card.red { border-left-color: var(--danger); }
        .stat-label { font-size: 0.6rem; text-transform: uppercase; opacity: 0.6; letter-spacing: 1px; }
        .stat-value { font-size: 1.5rem; font-weight: 600; margin-top: 5px; }

        /* Formulario */
        .section-header { 
            grid-column: span 12; margin: 20px 0 10px; padding-left: 10px;
            border-left: 3px solid var(--accent); font-size: 0.8rem; text-transform: uppercase; color: var(--accent);
        }

        .form-card {
            background: var(--glass); padding: 25px; border-radius: 20px; border: 1px solid var(--border);
            display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px;
        }

        .input-box { display: flex; flex-direction: column; gap: 5px; grid-column: span 3; }
        .col-2 { grid-column: span 2; }
        .col-4 { grid-column: span 4; }
        .col-6 { grid-column: span 6; }
        .col-12 { grid-column: span 12; }

        label { font-size: 0.65rem; opacity: 0.7; font-weight: 600; text-transform: uppercase; }

        input, select, textarea {
            background: rgba(0, 0, 0, 0.4); border: 1px solid var(--border);
            padding: 10px; border-radius: 8px; color: white; font-family: inherit; font-size: 0.85rem;
        }
        input:focus { border-color: var(--accent); outline: none; }
        input[readonly] { background: rgba(255,255,255,0.02); color: #60a5fa; cursor: not-allowed; border-style: dashed; }
        
        .solicitud-input { border: 1px solid var(--danger); color: var(--danger); font-weight: 600; }

        .search-container {
            background: rgba(59, 130, 246, 0.08); padding: 12px; border-radius: 12px; border: 1px solid var(--accent);
        }

        .btn-registrar {
            grid-column: span 12; background: var(--accent); color: white; border: none;
            padding: 16px; border-radius: 10px; font-weight: 600; cursor: pointer; margin-top: 10px;
        }

        #modalResumen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px);
        }
        .modal-content { background: #0f172a; padding: 30px; border-radius: 20px; border: 1px solid var(--accent); width: 400px; text-align: center; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <p>Sincronizando con YEPRI-INN...</p>
</div>

<div class="container">
    <div class="dashboard-mini">
        <div class="stat-card"><div class="stat-label">Registros Hoy</div><div class="stat-value">0</div></div>
        <div class="stat-card red"><div class="stat-label">üö® Vencen Hoy</div><div class="stat-value">1</div></div>
        <div class="stat-card"><div class="stat-label">En Proceso</div><div class="stat-value">11</div></div>
        <div class="stat-card"><div class="stat-label">Atendidos</div><div class="stat-value">2</div></div>
    </div>

    <div class="form-card">
        <h2 style="grid-column: span 12; margin: 0 0 10px 0; font-weight: 300;">Registro Maestro <span style="color:var(--accent)">Manual</span></h2>

        <div class="section-header">1. Identificadores del Registro</div>
        <div class="input-box"><label>Consecutivo</label><input type="text" id="consecutivo" readonly></div>
        <div class="input-box"><label>Folio Entrada (OFA-A)</label><input type="text" id="folio_e" readonly></div>
        <div class="input-box"><label>Folio Interno CSF</label><input type="text" id="folio_interno"></div>
        <div class="input-box"><label style="color:var(--danger)">Oficio de Solicitud</label><input type="text" id="oficio_solicitud" class="solicitud-input" placeholder="Ingresar folio..."></div>

        <div class="section-header">2. Informaci√≥n T√©cnica del Oficio</div>
        <div class="input-box col-2"><label>No. Oficio Emisor</label><input type="text" id="num_oficio_remitente"></div>
        <div class="input-box col-2"><label>Fecha Recepci√≥n</label><input type="date" id="fecha_recepcion" value="2026-02-24"></div>
        <div class="input-box col-2"><label>Medio</label><select id="medio"><option>Impreso (F√≠sico)</option><option>Digital (Correo)</option></select></div>
        <div class="input-box col-2"><label>Tipo Dispositivo</label><select id="tipo_dispositivo"><option>Ninguno</option><option>USB</option><option>CD/DVD</option></select></div>
        <div class="input-box col-2"><label>Cap. Info</label><input type="number" id="cap_info" value="0"></div>
        <div class="input-box col-2"><label>Unidad Medida</label><select id="unidad_medida"><option>N/A</option><option>MB</option><option>GB</option></select></div>

        <div class="section-header">3. Emisor y Seguimiento</div>
        <div class="input-box col-4 search-container">
            <label>üîç Buscar Sigla Emisor</label>
            <input type="text" id="busqueda" placeholder="Filtrar..." oninput="filtrarSiglas(this.value)">
            <select id="siglasEmisor" size="4" style="margin-top:5px" onchange="autoLlenarCampos(this.value)"></select>
            <small style="color:#fbbf24; font-size:10px">‚ö†Ô∏è Debe seleccionar de la lista</small>
        </div>
        <div class="input-box col-4"><label>Dependencia / Ente</label><input type="text" id="dependencia" readonly></div>
        <div class="input-box col-2"><label>Firmante</label><input type="text" id="firmante" readonly></div>
        <div class="input-box col-2"><label>Cargo</label><input type="text" id="puesto" readonly></div>
        
        <div class="input-box col-6"><label>Oficio que Atiende</label><input type="text" id="oficio_atiende"></div>
        <div class="input-box col-6"><label>Fecha Vencimiento</label><input type="date" id="fecha_vencimiento" value="2026-03-02"></div>

        <div class="section-header">4. Acciones y Asunto</div>
        <div class="input-box col-4"><label>Acci√≥n</label><select id="accion"><option>Para respuesta</option><option>Para conocimiento</option></select></div>
        <div class="input-box col-4"><label>Salidas (S-OFA)</label><input type="number" id="cantSalidas" value="0" min="0"></div>
        <div class="input-box col-4"><label>Estatus</label><select id="estatus"><option>Recibido</option><option>En Proceso</option></select></div>
        <div class="input-box col-12"><label>Asunto</label><textarea id="asunto" rows="3"></textarea></div>

        <button class="btn-registrar" id="btnMain" onclick="ejecutarRegistroGlobal()">Finalizar y Registrar en Supabase</button>
    </div>
</div>

<div id="modalResumen">
    <div class="modal-content">
        <h3 style="color:var(--success)">¬°Registro Exitoso!</h3>
        <div id="listaFolios" style="background:rgba(0,0,0,0.4); padding:15px; border-radius:10px; text-align:left; margin:15px 0; font-family:monospace; color:var(--accent);"></div>
        <button onclick="location.reload()" style="width:100%; padding:12px; border-radius:8px; cursor:pointer; background:var(--accent); color:white; border:none;">Finalizar</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const _supabase = supabase.createClient('https://zfztocmwphjfrabvbzlb.supabase.co', 'sb_publishable_cbOD6KTnjsGacu_GnAQm8g_nMuIoOIg');
    let todasLasSiglas = [];

    window.onload = async () => {
        const { data: enlaces } = await _supabase.from('enlacesdirec').select('*').order('sujeto');
        if (enlaces) { todasLasSiglas = enlaces; renderizarOpciones(enlaces); }
        
        const { data: folios } = await _supabase.rpc('generar_folios_duo_seguro');
        if(folios) {
            document.getElementById('consecutivo').value = folios[0].consecutivo_num;
            document.getElementById('folio_e').value = folios[0].folio_e;
        }
        document.getElementById('loader').style.display = 'none';
    };

    function renderizarOpciones(lista) {
        const select = document.getElementById('siglasEmisor');
        select.innerHTML = lista.map(item => `<option value="${item.sujeto}">${item.sujeto} | ${item.entidad}</option>`).join('');
    }

    function filtrarSiglas(t) {
        renderizarOpciones(todasLasSiglas.filter(i => i.sujeto.toLowerCase().includes(t.toLowerCase())));
    }

    function autoLlenarCampos(s) {
        const reg = todasLasSiglas.find(i => i.sujeto === s);
        if (reg) {
            document.getElementById('dependencia').value = reg.entidad;
            document.getElementById('firmante').value = reg.enlace;
            document.getElementById('puesto').value = reg.puesto;
        }
    }

    async function ejecutarRegistroGlobal() {
        const sigla = document.getElementById('siglasEmisor').value;
        const asunto = document.getElementById('asunto').value;
        if (!sigla || !asunto) return alert("Error: Seleccione sigla y escriba el asunto.");

        const btn = document.getElementById('btnMain');
        btn.disabled = true; btn.innerText = "Procesando...";

        try {
            const cons = document.getElementById('consecutivo').value;
            const fe = document.getElementById('folio_e').value;

            // 1. Insertar Correspondencia (TODOS LOS CAMPOS DE LA IMAGEN)
            const { error: err1 } = await _supabase.from('correspondencias').insert([{
                consecutivo: cons,
                folio_entrada: fe,
                folio_interno_csf: document.getElementById('folio_interno').value,
                oficio_solicitud: document.getElementById('oficio_solicitud').value,
                num_oficio_remitente: document.getElementById('num_oficio_remitente').value,
                fecha_recepcion: document.getElementById('fecha_recepcion').value,
                medio_recepcion: document.getElementById('medio').value,
                tipo_dispositivo: document.getElementById('tipo_dispositivo').value,
                capacidad_info: document.getElementById('cap_info').value,
                unidad_medida: document.getElementById('unidad_medida').value,
                siglas_emisor: sigla,
                dependencia: document.getElementById('dependencia').value,
                firmante: document.getElementById('firmante').value,
                cargo: document.getElementById('puesto').value,
                oficio_que_atiende: document.getElementById('oficio_atiende').value,
                fecha_vencimiento: document.getElementById('fecha_vencimiento').value,
                accion: document.getElementById('accion').value,
                estatus: document.getElementById('estatus').value,
                asunto: asunto
            }]);
            if (err1) throw err1;

            // 2. Insertar Folio Entrada
            await _supabase.from('folios_entrada').insert([{ consecutivo: cons, ofa_e_folio: fe, origen: sigla }]);

            // 3. Salidas
            const n = parseInt(document.getElementById('cantSalidas').value);
            if (n > 0) {
                const salidas = [];
                for (let i = 1; i <= n; i++) {
                    salidas.push({ consecutivo_madre: cons, ofa_s_folio: `S-OFA-` + i.toString().padStart(4, '0') });
                }
                await _supabase.from('folios_salida').insert(salidas);
            }

            document.getElementById('listaFolios').innerHTML = `Folio Entrada: ${fe}<br>Salidas Generadas: ${n}`;
            document.getElementById('modalResumen').style.display = 'flex';
        } catch (e) {
            alert(e.message); btn.disabled = false;
        }
    }
</script>
</body>
</html>
