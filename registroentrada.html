<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Entrada | OFAS METAX PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary: #1e293b;
            --accent: #3b82f6;
            --bg: #f8fafc;
            --white: #ffffff;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: var(--primary);
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: var(--white);
            padding: 35px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }

        header {
            border-bottom: 2px solid #f1f5f9;
            margin-bottom: 30px;
            padding-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            grid-column: span 3;
            background: #f1f5f9;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 800;
            color: var(--accent);
            margin: 20px 0 10px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .field { display: flex; flex-direction: column; }
        .field label { font-size: 0.75rem; font-weight: 700; margin-bottom: 6px; color: #64748b; text-transform: uppercase; }
        
        input, select, textarea {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.2s;
        }

        input:focus, select:focus, textarea:focus { 
            border-color: var(--accent); 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); 
        }

        .full { grid-column: span 3; }
        .double { grid-column: span 2; }

        .btn-save {
            grid-column: span 3;
            background: var(--accent);
            color: white;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 30px;
            transition: transform 0.2s, background 0.3s;
        }

        .btn-save:hover { background: #2563eb; transform: translateY(-2px); }
        .btn-back { text-decoration: none; color: #64748b; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 5px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1 style="margin:0; font-size: 1.6rem;">Registro de Entrada Manual</h1>
            <p style="margin:5px 0 0; color:#64748b;">OFAS METAX PRO | tu meta, tu tiempo, tu historia</p>
        </div>
        <a href="bienvenida.html" class="btn-back">‚¨Ö Volver al Panel</a>
    </header>

    <form id="registroEntradaForm" class="form-grid">
        
        <div class="section-title">1. Control de Folios e Ingreso</div>
        <div class="field">
            <label>Consecutivo (Autom√°tico)</label>
            <input type="text" id="conse_regis" placeholder="ID autom√°tico" disabled>
        </div>
        <div class="field">
            <label>Folio Entrada (OFA_E)</label>
            <input type="text" id="ofa_e" placeholder="Ej: E-OFA-00001" required>
        </div>
        <div class="field">
            <label>Folio Interno</label>
            <input type="text" id="folio_inter" placeholder="Referencia interna">
        </div>
        <div class="field double">
            <label>N√∫mero de Oficio a Ingresar</label>
            <input type="text" id="num_oficio_ingresar" required placeholder="Ej: AECF(CIC)/MSIL2124/009">
        </div>
        <div class="field">
            <label>Fecha Ingreso Oficio</label>
            <input type="date" id="fecha_ingreo_ofi" required>
        </div>

        <div class="section-title">2. Informaci√≥n del Emisor</div>
        <div class="field">
            <label>Siglas Emisor</label>
            <input type="text" id="siglas_emis" placeholder="Ej: CF-ASEG">
        </div>
        <div class="field double">
            <label>Dependencia / Ente</label>
            <input type="text" id="entidad_dep" required placeholder="Nombre de la Instituci√≥n">
        </div>
        <div class="field">
            <label>Firmante</label>
            <input type="text" id="quien_firma" placeholder="Nombre completo">
        </div>
        <div class="field double">
            <label>Cargo / Puesto</label>
            <input type="text" id="puesto_firma" placeholder="Cargo del firmante">
        </div>

        <div class="section-title">3. Detalles T√©cnicos (Dispositivos)</div>
        <div class="field">
            <label>Medio de Entrega</label>
            <select id="medio_entrega">
                <option value="Fisico">F√≠sico</option>
                <option value="Digital">Digital</option>
                <option value="Correo">Correo Electr√≥nico</option>
            </select>
        </div>
        <div class="field">
            <label>Tipo Dispositivo</label>
            <input type="text" id="tipo_dispo" placeholder="USB, CD, Disco, etc.">
        </div>
        <div class="field">
            <label>Capacidad (Info)</label>
            <input type="text" id="cap_info" placeholder="Ej: 500">
        </div>
        <div class="field">
            <label>Unidad Medida</label>
            <select id="uni_medi">
                <option value="N/A">N/A</option>
                <option value="MB">MB</option>
                <option value="GB">GB</option>
                <option value="TB">TB</option>
                <option value="Fojas">Fojas</option>
            </select>
        </div>

        <div class="section-title">4. Seguimiento y Estatus</div>
        <div class="field full">
            <label>Asunto / Firma</label>
            <textarea id="asunto_firma" rows="2" placeholder="Resumen del asunto del oficio..."></textarea>
        </div>
        <div class="field">
            <label>Oficio que Atiende</label>
            <input type="text" id="ofi_firmante" placeholder="Referencia previa">
        </div>
        <div class="field">
            <label>Fecha Vencimiento</label>
            <input type="date" id="fecha_venci">
        </div>
        <div class="field">
            <label>Acci√≥n a Realizar</label>
            <input type="text" id="accion_realizar">
        </div>
        <div class="field">
            <label>Folio Salida (OFA_S)</label>
            <input type="text" id="ofa_s" placeholder="Folio de respuesta">
        </div>
        <div class="field">
            <label>Estatus</label>
            <select id="estatus">
                <option value="Pendiente">Pendiente</option>
                <option value="En Tr√°mite">En Tr√°mite</option>
                <option value="Turnado">Turnado</option>
                <option value="Atendido">Atendido</option>
            </select>
        </div>
        <div class="field full">
            <label>Comentarios</label>
            <input type="text" id="comenta" placeholder="Notas administrativas adicionales">
        </div>

        <button type="submit" class="btn-save">üíæ Guardar Registro en Base de Datos</button>
    </form>
</div>

<script>
    // Configuraci√≥n de Supabase
    const SB_URL = 'TU_URL_DE_SUPABASE';
    const SB_KEY = 'TU_ANON_KEY';
    const supabase = supabase.createClient(SB_URL, SB_KEY);

    const form = document.getElementById('registroEntradaForm');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // 1. Verificar Sesi√≥n para Auditor√≠a
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
            alert("‚ö†Ô∏è Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.");
            window.location.href = 'index.html';
            return;
        }

        // 2. Mapeo de los 20 campos t√©cnicos
        const registro = {
            ofa_e: document.getElementById('ofa_e').value,
            folio_inter: document.getElementById('folio_inter').value,
            num_oficio_ingresar: document.getElementById('num_oficio_ingresar').value,
            fecha_ingreo_ofi: document.getElementById('fecha_ingreo_ofi').value,
            siglas_emis: document.getElementById('siglas_emis').value,
            entidad_dep: document.getElementById('entidad_dep').value,
            quien_firma: document.getElementById('quien_firma').value,
            puesto_firma: document.getElementById('puesto_firma').value,
            medio_entrega: document.getElementById('medio_entrega').value,
            tipo_dispo: document.getElementById('tipo_dispo').value,
            cap_info: document.getElementById('cap_info').value,
            uni_medi: document.getElementById('uni_medi').value,
            asunto_firma: document.getElementById('asunto_firma').value,
            ofi_firmante: document.getElementById('ofi_firmante').value,
            fecha_venci: document.getElementById('fecha_venci').value || null,
            accion_realizar: document.getElementById('accion_realizar').value,
            ofa_s: document.getElementById('ofa_s').value,
            estatus: document.getElementById('estatus').value,
            comenta: document.getElementById('comenta').value,
            creado_por: session.user.id
        };

        try {
            // 3. Insertar Registro Principal
            const { data, error } = await supabase
                .from('correspondencias')
                .insert([registro])
                .select()
                .single();

            if (error) throw error;

            // 4. Registro de Log de Auditor√≠a Autom√°tico
            await supabase.from('logs_auditoria').insert([{
                usuario_id: session.user.id,
                accion: 'REGISTRO_MANUAL',
                tabla_afectada: 'correspondencias',
                registro_id: data.id,
                detalle: `Registro exitoso del oficio ${registro.num_oficio_ingresar} (Folio: ${registro.ofa_e})`
            }]);

            alert("‚úÖ ¬°Registro OFAS METAX PRO guardado con √©xito!");
            form.reset();

        } catch (error) {
            console.error("Error:", error.message);
            alert("‚ùå Error al guardar: " + error.message);
        }
    });
</script>

</body>
</html>
