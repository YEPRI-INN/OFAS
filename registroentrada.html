<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registro Maestro | YEPRI-INN METAX</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #3b82f6;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.12);
            --bg: #020617;
            --success: #4ade80;
        }

        body {
            margin: 0; font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top right, #111827, #020617);
            color: white; min-height: 100vh; padding: 40px;
        }

        /* Loader */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--glass); border-top: 3px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .container { max-width: 1100px; margin: 0 auto; }
        
        .section-header { 
            grid-column: span 2; margin: 20px 0 10px; padding-left: 10px;
            border-left: 3px solid var(--accent); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px; color: var(--accent);
        }

        .form-card {
            background: var(--glass); padding: 30px; border-radius: 20px; border: 1px solid var(--border);
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }

        .input-box { display: flex; flex-direction: column; gap: 5px; }
        .full-width { grid-column: span 2; }

        label { font-size: 0.65rem; opacity: 0.6; font-weight: 600; }

        input, select, textarea {
            background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border);
            padding: 10px; border-radius: 8px; color: white; font-family: inherit; font-size: 0.9rem;
        }

        input[readonly] { background: rgba(255,255,255,0.02); color: #60a5fa; cursor: not-allowed; border-style: dashed; }

        .search-container {
            background: rgba(59, 130, 246, 0.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.2);
        }
        #siglasEmisor { height: 100px; margin-top: 10px; width: 100%; }
        .alert-select { font-size: 0.7rem; color: #fbbf24; margin-top: 5px; display: block; }

        .switch-area {
            grid-column: span 2; background: rgba(255,255,255,0.03); padding: 20px; border-radius: 12px;
            display: flex; align-items: center; justify-content: space-between; border: 1px solid var(--border);
        }

        .btn-registrar {
            grid-column: span 2; background: var(--accent); color: white; border: none;
            padding: 15px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: 0.2s;
        }

        #modalResumen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px);
        }
        .modal-content { background: #111827; padding: 30px; border-radius: 20px; border: 1px solid var(--accent); width: 400px; text-align: center; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <p style="margin-top:15px">Cargando Datos de Enlace...</p>
</div>

<div class="container">
    <div class="form-card">
        <h2 style="grid-column: span 2; margin: 0; font-weight: 300;">Registro de Correspondencia <span style="color:var(--accent)">Manual</span></h2>

        <div class="section-header">1. Informaci√≥n del Remitente</div>
        <div class="input-box full-width search-container">
            <label>üîç Buscar Siglas</label>
            <input type="text" id="busquedaSiglas" placeholder="Escriba para filtrar siglas..." oninput="filtrarSiglas(this.value)">
            <select id="siglasEmisor" size="5" onchange="autoLlenarCampos(this.value)"></select>
            <span class="alert-select">‚ö†Ô∏è Selecciona una sigla de la lista para cargar los datos.</span>
        </div>

        <div class="input-box"><label>Dependencia / Ente</label><input type="text" id="dependencia" readonly></div>
        <div class="input-box"><label>Firmante (Enlace)</label><input type="text" id="firmante" readonly></div>
        <div class="input-box full-width"><label>Cargo / Puesto</label><input type="text" id="puesto" readonly></div>

        <div class="section-header">2. Detalles del Documento</div>
        <div class="input-box"><label>N√∫mero de Oficio</label><input type="text" id="numOficio"></div>
        <div class="input-box"><label>Fecha Doc</label><input type="date" id="fechaDoc"></div>
        <div class="input-box">
            <label>‚öñÔ∏è Gesti√≥n</label>
            <select id="tipoGestion">
                <option value="Administrativo">üìÇ Administrativo</option>
                <option value="T√©cnico">üõ†Ô∏è T√©cnico</option>
                <option value="Legal">‚öñÔ∏è Legal</option>
                <option value="Urgente">üö® Urgente</option>
            </select>
        </div>
        <div class="input-box">
            <label>üíæ Dispositivo</label>
            <select id="tipoDispositivo" onchange="verificarOtro(this.value)">
                <option value="N/A">üö´ Ninguno</option>
                <option value="CD 700 MB">üíø CD</option>
                <option value="USB 16 GB">‚ö° USB 16GB</option>
                <option value="Otro">üõ†Ô∏è Otro</option>
            </select>
        </div>
        <div class="input-box full-width" id="especificarOtroBox" style="display:none"><input type="text" id="otroDetalle" placeholder="Especificar..."></div>
        <div class="input-box full-width"><label>üìù Asunto</label><textarea id="asunto" rows="3"></textarea></div>

        <div class="section-header">3. Control de Folios</div>
        <div class="switch-area">
            <div><strong>¬øGenerar Salidas (S-OFA)?</strong></div>
            <div style="display:flex; gap:10px"><input type="checkbox" id="checkSalida"><input type="number" id="cantSalidas" value="1" min="1" style="width:50px"></div>
        </div>
        <button class="btn-registrar" id="btnMain" onclick="ejecutarRegistroGlobal()">Registrar Entrada</button>
    </div>
</div>

<div id="modalResumen">
    <div class="modal-content">
        <h3 style="color:var(--success)">¬°√âxito!</h3>
        <div id="listaFolios" style="background:rgba(0,0,0,0.4); padding:15px; border-radius:10px; text-align:left; margin:15px 0; font-family:monospace; color:var(--accent);"></div>
        <button onclick="copiarFolios()" style="padding:10px; width:45%; cursor:pointer">üìã Copiar</button>
        <button onclick="location.reload()" style="padding:10px; width:45%; cursor:pointer; background:var(--accent); color:white; border:none">Cerrar</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const _supabase = supabase.createClient('https://zfztocmwphjfrabvbzlb.supabase.co', 'sb_publishable_cbOD6KTnjsGacu_GnAQm8g_nMuIoOIg');
    let todasLasSiglas = [];
    let textoCopia = "";

    window.onload = async () => {
        try {
            const { data, error } = await _supabase.from('enlacesdirec').select('*').order('sujeto');
            if (error) throw error;
            todasLasSiglas = data;
            renderizarOpciones(data);
            document.getElementById('loader').style.display = 'none';
        } catch (e) { alert("Error al cargar siglas: " + e.message); }
    };

    function renderizarOpciones(lista) {
        const select = document.getElementById('siglasEmisor');
        select.innerHTML = lista.map(item => `<option value="${item.sujeto}">üè¢ ${item.sujeto} | ${item.entidad}</option>`).join('');
    }

    function filtrarSiglas(t) {
        renderizarOpciones(todasLasSiglas.filter(i => i.sujeto.toLowerCase().includes(t.toLowerCase())));
    }

    function autoLlenarCampos(s) {
        const reg = todasLasSiglas.find(i => i.sujeto === s);
        if (reg) {
            document.getElementById('dependencia').value = reg.entidad;
            document.getElementById('firmante').value = reg.enlace;
            document.getElementById('puesto').value = reg.puesto;
        }
    }

    function verificarOtro(v) { document.getElementById('especificarOtroBox').style.display = (v === 'Otro') ? 'flex' : 'none'; }

    async function ejecutarRegistroGlobal() {
        const sigla = document.getElementById('siglasEmisor').value;
        const asunto = document.getElementById('asunto').value;
        if (!sigla || !asunto) return alert("Selecciona una sigla y escribe el asunto.");

        const btn = document.getElementById('btnMain');
        btn.disabled = true;

        try {
            const { data: info, error: rpcErr } = await _supabase.rpc('generar_folios_duo_seguro');
            if (rpcErr) throw rpcErr;
            const { consecutivo_num, folio_e } = info[0];

            await _supabase.from('correspondencias').insert([{
                consecutivo: consecutivo_num,
                siglas_emisor: sigla,
                asunto: asunto,
                folio_entrada: folio_e,
                num_oficio_remitente: document.getElementById('numOficio').value,
                fecha_documento: document.getElementById('fechaDoc').value
            }]);

            await _supabase.from('folios_entrada').insert([{ consecutivo: consecutivo_num, ofa_e_folio: folio_e, origen: sigla }]);

            let resHtml = `Entrada: <strong>${folio_e}</strong><br>`;
            textoCopia = `FOLIO: ${folio_e}\n`;

            if (document.getElementById('checkSalida').checked) {
                const n = parseInt(document.getElementById('cantSalidas').value);
                const salidas = [];
                for (let i = 1; i <= n; i++) {
                    const f = `S-OFA-` + i.toString().padStart(5, '0');
                    salidas.push({ consecutivo_madre: consecutivo_num, ofa_s_folio: f });
                    resHtml += `‚Ä¢ ${f}<br>`;
                    textoCopia += `- ${f}\n`;
                }
                await _supabase.from('folios_salida').insert(salidas);
            }

            document.getElementById('listaFolios').innerHTML = resHtml;
            document.getElementById('modalResumen').style.display = 'flex';
        } catch (e) { alert(e.message); btn.disabled = false; }
    }

    function copiarFolios() { navigator.clipboard.writeText(textoCopia); alert("Copiado."); }
</script>
</body>
</html>
