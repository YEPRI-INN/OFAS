<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registro Maestro | YEPRI-INN METAX</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #3b82f6; --glass: rgba(255, 255, 255, 0.05); --border: rgba(255, 255, 255, 0.12);
            --bg: #020617; --success: #4ade80; --danger: #ef4444;
        }
        body { margin: 0; font-family: 'Inter', sans-serif; background: radial-gradient(circle at top right, #111827, #020617); color: white; padding: 20px; min-height: 100vh; }
        
        /* Stats */
        .dashboard-mini { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--glass); padding: 15px; border-radius: 12px; border: 1px solid var(--border); border-left: 4px solid var(--accent); }
        .stat-label { font-size: 0.6rem; text-transform: uppercase; opacity: 0.6; }
        .stat-value { font-size: 1.5rem; font-weight: 600; }

        /* Form */
        .form-card { background: var(--glass); padding: 25px; border-radius: 20px; border: 1px solid var(--border); display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        .section-header { grid-column: span 12; margin: 15px 0 5px; border-left: 3px solid var(--accent); padding-left: 10px; color: var(--accent); font-size: 0.8rem; text-transform: uppercase; }
        
        .input-box { display: flex; flex-direction: column; gap: 5px; grid-column: span 3; }
        .full-width { grid-column: span 12; }
        
        label { font-size: 0.65rem; opacity: 0.7; font-weight: 600; }
        input, select, textarea { background: rgba(0, 0, 0, 0.4); border: 1px solid var(--border); padding: 10px; border-radius: 8px; color: white; font-size: 0.85rem; font-family: inherit; }
        input[readonly] { background: rgba(255,255,255,0.02); color: #60a5fa; cursor: not-allowed; border-style: dashed; }
        .solicitud-input { border: 1.5px solid var(--danger); color: var(--danger); }

        .btn-search-sigla { background: var(--accent); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 5px; }

        /* Modales */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal-content { background: #0f172a; padding: 25px; border-radius: 15px; border: 1px solid var(--accent); width: 450px; text-align: center; }
        
        #listaSiglasEmergente { width: 100%; background: #1e293b; color: white; border: 1px solid var(--border); border-radius: 8px; margin-top: 10px; }

        .btn-registrar { grid-column: span 12; background: var(--accent); color: white; padding: 18px; border-radius: 12px; font-weight: 600; cursor: pointer; border: none; margin-top: 20px; font-size: 1rem; }
        
        /* Switch */
        .switch-area { grid-column: span 12; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; border: 1px solid var(--border); }

        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 3000; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="loader"><div style="width:40px;height:40px;border:4px solid var(--glass);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;"></div></div>

<div class="container">
    <div class="dashboard-mini">
        <div class="stat-card"><div class="stat-label">Registros Hoy</div><div class="stat-value">0</div></div>
        <div class="stat-card" style="border-left-color:var(--danger)"><div class="stat-label">üö® Vencen Hoy</div><div class="stat-value" style="color:var(--danger)">1</div></div>
        <div class="stat-card"><div class="stat-label">En Proceso</div><div class="stat-value">11</div></div>
        <div class="stat-card"><div class="stat-label">Atendidos</div><div class="stat-value">2</div></div>
    </div>

    <div class="form-card">
        <h2 style="grid-column: span 12; margin:0 0 10px 0;">Registro Maestro <span style="color:var(--accent)">Manual</span></h2>

        <div class="section-header">1. Identificadores y Emisor</div>
        <div class="input-box"><label>Consecutivo</label><input type="text" id="cons" readonly></div>
        <div class="input-box"><label>Folio Entrada</label><input type="text" id="fe" readonly></div>
        <div class="input-box"><label>Folio Interno CSF</label><input type="text" id="f_int"></div>
        <div class="input-box"><label style="color:var(--danger)">Oficio de Solicitud</label><input type="text" id="of_sol" class="solicitud-input"></div>

        <div class="input-box col-4">
            <label>Siglas Emisor</label>
            <input type="text" id="sigla_display" readonly placeholder="Haga clic para buscar..." onclick="abrirSelector()" style="cursor:pointer; border-color:var(--accent); background:rgba(59,130,246,0.1)">
            <button class="btn-search-sigla" onclick="abrirSelector()">üîç Buscar Sigla</button>
        </div>
        <div class="input-box col-4"><label>Dependencia</label><input type="text" id="dep" readonly></div>
        <div class="input-box col-2"><label>Firmante</label><input type="text" id="fir" readonly></div>
        <div class="input-box col-2"><label>Cargo</label><input type="text" id="car" readonly></div>

        <div class="section-header">2. Detalles del Documento y Gesti√≥n</div>
        <div class="input-box"><label>No. Oficio Emisor</label><input type="text" id="n_ofi"></div>
        <div class="input-box"><label>Fecha Documento</label><input type="date" id="f_doc"></div>
        
        <div class="input-box">
            <label>‚öñÔ∏è Tipo de Gesti√≥n</label>
            <select id="tipoGestion">
                <option value="Administrativo">üìÇ Administrativo</option>
                <option value="T√©cnico">üõ†Ô∏è T√©cnico / Operativo</option>
                <option value="Legal">‚öñÔ∏è Legal / Jur√≠dico</option>
                <option value="Urgente">üö® Asunto Urgente</option>
            </select>
        </div>

        <div class="input-box">
            <label>üíæ Tipo de Dispositivo</label>
            <select id="tipoDispositivo" onchange="verificarOtro(this.value)">
                <option value="N/A">üö´ Ninguno</option>
                <option value="CD 700 MB">üíø CD - 700 MB</option>
                <option value="DVD 4.5 GB">üìÄ DVD - 4.5 GB</option>
                <option value="USB 16 GB">‚ö° USB - 16 GB</option>
                <option value="USB 32 GB">‚ö° USB - 32 GB</option>
                <option value="Otro">üõ†Ô∏è Otro (Especificar)</option>
            </select>
        </div>

        <div class="input-box full-width" id="especificarOtroBox" style="display:none">
            <label>üîç Especificar Dispositivo</label>
            <input type="text" id="otroDetalle" placeholder="Describa el dispositivo...">
        </div>

        <div class="input-box full-width">
            <label>üìù Asunto / Extracto</label>
            <textarea id="asunto" rows="3" placeholder="Descripci√≥n breve..."></textarea>
        </div>

        <div class="section-header">3. Control de Folios (YEPRI-INN)</div>
        <div class="switch-area">
            <div>
                <strong>¬øGenerar Folios de Salida (S-OFA)?</strong>
                <small style="display:block; opacity:0.5">Vincular serie de salida autom√°ticamente.</small>
            </div>
            <div style="display:flex; gap:10px; align-items:center">
                <input type="checkbox" id="checkSalida" style="width:20px;height:20px">
                <input type="number" id="cantSalidas" value="1" min="1" style="width:60px; text-align:center">
            </div>
        </div>

        <button class="btn-registrar" id="btnSave" onclick="ejecutarGuardado()">Finalizar y Registrar en Supabase</button>
    </div>
</div>

<div id="modalSiglas" class="modal">
    <div class="modal-content">
        <h3>Seleccionar Sigla</h3>
        <input type="text" id="txtFiltro" placeholder="Filtrar..." oninput="filtrarEmergente(this.value)" style="width:100%; margin-bottom:10px; box-sizing:border-box">
        <select id="listaSiglasEmergente" size="10" onchange="seleccionarDeModal(this.value)"></select>
        <button onclick="cerrarSelector()" style="width:100%; margin-top:15px; background:var(--danger); color:white; border:none; padding:10px; border-radius:8px">Cancelar</button>
    </div>
</div>

<div id="modalResumen" class="modal">
    <div class="modal-content" style="border-color:var(--success)">
        <h3 style="color:var(--success)">¬°Registro Exitoso!</h3>
        <div id="resumenTexto" style="background:rgba(0,0,0,0.3); padding:15px; border-radius:10px; text-align:left; font-family:monospace; font-size:0.9rem; margin-bottom:15px; color:var(--accent)"></div>
        <div style="display:flex; gap:10px">
            <button onclick="copiarResumen()" style="flex:1; padding:12px; background:var(--glass); color:white; border:1px solid var(--border); border-radius:8px; cursor:pointer">üìã Copiar</button>
            <button onclick="location.reload()" style="flex:1; padding:12px; background:var(--success); color:black; border:none; border-radius:8px; cursor:pointer; font-weight:600">Finalizar</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const _supabase = supabase.createClient('https://zfztocmwphjfrabvbzlb.supabase.co', 'sb_publishable_cbOD6KTnjsGacu_GnAQm8g_nMuIoOIg');
    let dataCache = [];
    let textoParaCopiar = "";

    window.onload = async () => {
        const { data: enlaces } = await _supabase.from('enlacesdirec').select('*').order('sujeto');
        dataCache = enlaces;
        const { data: folios } = await _supabase.rpc('generar_folios_duo_seguro');
        if(folios) {
            document.getElementById('cons').value = folios[0].consecutivo_num;
            document.getElementById('fe').value = folios[0].folio_e;
        }
        document.getElementById('loader').style.display = 'none';
    };

    function abrirSelector() { document.getElementById('modalSiglas').style.display = 'flex'; filtrarEmergente(''); }
    function cerrarSelector() { document.getElementById('modalSiglas').style.display = 'none'; }
    function verificarOtro(v) { document.getElementById('especificarOtroBox').style.display = (v === 'Otro') ? 'flex' : 'none'; }

    function filtrarEmergente(t) {
        const lista = dataCache.filter(i => i.sujeto.toLowerCase().includes(t.toLowerCase()));
        const sel = document.getElementById('listaSiglasEmergente');
        sel.innerHTML = lista.map(i => `<option value="${i.sujeto}">${i.sujeto} - ${i.entidad.substring(0,40)}...</option>`).join('');
    }

    function seleccionarDeModal(val) {
        const item = dataCache.find(i => i.sujeto === val);
        if(item) {
            document.getElementById('sigla_display').value = item.sujeto;
            document.getElementById('dep').value = item.entidad;
            document.getElementById('fir').value = item.enlace;
            document.getElementById('car').value = item.puesto;
            cerrarSelector();
        }
    }

    async function ejecutarGuardado() {
        const btn = document.getElementById('btnSave');
        const sigla = document.getElementById('sigla_display').value;
        if(!sigla || !document.getElementById('asunto').value) return alert("Faltan datos.");

        btn.disabled = true; btn.innerText = "Registrando...";
        try {
            const c = document.getElementById('cons').value;
            const f = document.getElementById('fe').value;
            
            // 1. Base
            await _supabase.from('correspondencias').insert([{
                consecutivo: c, folio_entrada: f, siglas_emisor: sigla, 
                asunto: document.getElementById('asunto').value,
                oficio_solicitud: document.getElementById('of_sol').value
            }]);
            await _supabase.from('folios_entrada').insert([{ consecutivo: c, ofa_e_folio: f, origen: sigla }]);

            // 2. Resumen
            let resHtml = `FOLIO ENTRADA: ${f}<br>`;
            textoParaCopiar = `ENTRADA: ${f}\n`;

            // 3. Salidas
            if(document.getElementById('checkSalida').checked) {
                const n = parseInt(document.getElementById('cantSalidas').value);
                const salidas = [];
                for(let i=1; i<=n; i++) {
                    const fs = `S-OFA-` + i.toString().padStart(4, '0');
                    salidas.push({ consecutivo_madre: c, ofa_s_folio: fs });
                    resHtml += `‚Ä¢ SALIDA: ${fs}<br>`;
                    textoParaCopiar += `SALIDA: ${fs}\n`;
                }
                await _supabase.from('folios_salida').insert(salidas);
            }

            document.getElementById('resumenTexto').innerHTML = resHtml;
            document.getElementById('modalResumen').style.display = 'flex';
        } catch(e) { alert(e.message); btn.disabled = false; }
    }

    function copiarResumen() {
        navigator.clipboard.writeText(textoParaCopiar);
        alert("Folios copiados!");
    }
</script>
</body>
</html>
